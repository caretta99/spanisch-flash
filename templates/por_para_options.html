{% extends "base.html" %}

{% block title %}Por vs Para Quiz Options - Jona's Spanish Quiz{% endblock %}

{% block content %}
<div class="options-page">
    <h2>Por vs Para Quiz Options</h2>
    
    <form method="POST" action="{{ url_for('porpara_start_quiz') }}" class="options-form">
        <div class="form-sections-grid">
            <div class="form-section">
                <div class="section-header">
                    <h3>Select Por Categories</h3>
                    <div class="select-all-buttons">
                        <button type="button" class="btn btn-small btn-select-all" onclick="selectAllPor()">Select All</button>
                        <button type="button" class="btn btn-small btn-deselect-all" onclick="deselectAllPor()">Deselect All</button>
                    </div>
                </div>
                <div class="checkbox-group por-categories">
                    {% for category_key, category_name in por_categories.items() %}
                    <label class="checkbox-label">
                        <input type="checkbox" name="por_categories" value="{{ category_key }}" 
                               {% if category_key in saved_prefs.selected_por_categories %}checked{% endif %}>
                        <span>{{ category_name }}</span>
                    </label>
                    {% endfor %}
                </div>
            </div>
            
            <div class="form-section">
                <div class="section-header">
                    <h3>Select Para Categories</h3>
                    <div class="select-all-buttons">
                        <button type="button" class="btn btn-small btn-select-all" onclick="selectAllPara()">Select All</button>
                        <button type="button" class="btn btn-small btn-deselect-all" onclick="deselectAllPara()">Deselect All</button>
                    </div>
                </div>
                <div class="checkbox-group para-categories">
                    {% for category_key, category_name in para_categories.items() %}
                    <label class="checkbox-label">
                        <input type="checkbox" name="para_categories" value="{{ category_key }}" 
                               {% if category_key in saved_prefs.selected_para_categories %}checked{% endif %}>
                        <span>{{ category_name }}</span>
                    </label>
                    {% endfor %}
                </div>
            </div>
            
            <div class="form-section">
                <h3>Contest Mode (Optional)</h3>
                <div class="contestant-section">
                    <div class="contestant-header">
                        <label>Contestant Names:</label>
                        <div class="contestant-buttons">
                            <button type="button" class="btn btn-small btn-select-all" onclick="addContestantBox()">Add Contestant</button>
                        </div>
                    </div>
                    <div id="contestant-inputs" class="contestant-inputs">
                        {% if saved_prefs.contestants %}
                            {% for contestant in saved_prefs.contestants %}
                            <div class="contestant-input-wrapper">
                                <input type="text" name="contestants" class="contestant-input" 
                                       value="{{ contestant }}" placeholder="Contestant {{ loop.index }}">
                                <button type="button" class="btn-remove-contestant" onclick="removeContestantBox(this)" 
                                        {% if saved_prefs.contestants|length <= 2 %}style="display: none;"{% endif %}>×</button>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="contestant-input-wrapper">
                                <input type="text" name="contestants" class="contestant-input" placeholder="Contestant 1">
                                <button type="button" class="btn-remove-contestant" onclick="removeContestantBox(this)" style="display: none;">×</button>
                            </div>
                            <div class="contestant-input-wrapper">
                                <input type="text" name="contestants" class="contestant-input" placeholder="Contestant 2">
                                <button type="button" class="btn-remove-contestant" onclick="removeContestantBox(this)" style="display: none;">×</button>
                            </div>
                        {% endif %}
                    </div>
                    <p class="contestant-hint">Leave empty to disable contest mode</p>
                </div>
            </div>
            
            <div class="form-section">
                <h3>Quiz Settings</h3>
                <div class="input-group">
                    <label for="seconds_per_question">Seconds per question:</label>
                    <input type="number" id="seconds_per_question" name="seconds_per_question" 
                           value="{{ saved_prefs.seconds_per_question }}" min="1" max="60" required>
                </div>
                <div class="input-group">
                    <label for="seconds_per_answer">Seconds per answer:</label>
                    <input type="number" id="seconds_per_answer" name="seconds_per_answer" 
                           value="{{ saved_prefs.seconds_per_answer }}" min="1" max="60" required>
                </div>
                <div class="input-group">
                    <label for="num_questions">Number of questions:</label>
                    <input type="number" id="num_questions" name="num_questions" 
                           value="{{ saved_prefs.num_questions }}" min="1" max="100" required>
                </div>
            </div>
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn btn-primary">Start Quiz</button>
            <button type="button" class="btn btn-secondary" onclick="saveAndReturnToMain()">Return to Main</button>
        </div>
    </form>
</div>

<script>
function selectAllPor() {
    const checkboxes = document.querySelectorAll('input[name="por_categories"]');
    checkboxes.forEach(checkbox => checkbox.checked = true);
}

function deselectAllPor() {
    const checkboxes = document.querySelectorAll('input[name="por_categories"]');
    checkboxes.forEach(checkbox => checkbox.checked = false);
}

function selectAllPara() {
    const checkboxes = document.querySelectorAll('input[name="para_categories"]');
    checkboxes.forEach(checkbox => checkbox.checked = true);
}

function deselectAllPara() {
    const checkboxes = document.querySelectorAll('input[name="para_categories"]');
    checkboxes.forEach(checkbox => checkbox.checked = false);
}

let contestantCounter = {{ saved_prefs.contestants|length if saved_prefs.contestants and saved_prefs.contestants|length > 0 else 2 }};

function addContestantBox() {
    contestantCounter++;
    const container = document.getElementById('contestant-inputs');
    const wrapper = document.createElement('div');
    wrapper.className = 'contestant-input-wrapper';
    wrapper.innerHTML = `
        <input type="text" name="contestants" class="contestant-input" placeholder="Contestant ${contestantCounter}">
        <button type="button" class="btn-remove-contestant" onclick="removeContestantBox(this)">×</button>
    `;
    container.appendChild(wrapper);
    updateRemoveButtons();
}

function removeContestantBox(button) {
    const container = document.getElementById('contestant-inputs');
    if (container.children.length > 2) {
        button.parentElement.remove();
        updateRemoveButtons();
    }
}

function updateRemoveButtons() {
    const container = document.getElementById('contestant-inputs');
    const removeButtons = container.querySelectorAll('.btn-remove-contestant');
    removeButtons.forEach(btn => {
        btn.style.display = container.children.length > 2 ? 'block' : 'none';
    });
}

function saveAndReturnToMain() {
    // Create a form to submit settings
    const form = document.querySelector('.options-form');
    const formData = new FormData(form);
    
    // Create a temporary form to submit
    const tempForm = document.createElement('form');
    tempForm.method = 'POST';
    tempForm.action = '{{ url_for("porpara_save_settings") }}';
    
    // Collect all unique keys first to avoid duplicates
    const processedKeys = new Set();
    
    // Copy all form data
    for (const [key, value] of formData.entries()) {
        // Skip if we've already processed this key
        if (processedKeys.has(key)) {
            continue;
        }
        
        processedKeys.add(key);
        
        // Get all values for this key
        const allValues = formData.getAll(key);
        
        if (allValues.length > 1) {
            // Multiple values (checkboxes, contestants, etc.)
            allValues.forEach(val => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = val;
                tempForm.appendChild(input);
            });
        } else {
            // Single value
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = key;
            input.value = value;
            tempForm.appendChild(input);
        }
    }
    
    document.body.appendChild(tempForm);
    tempForm.submit();
}

// Initialize remove buttons on page load
document.addEventListener('DOMContentLoaded', () => {
    updateRemoveButtons();
});
</script>
{% endblock %}
